// Wardrobe AI Closet - Prisma Schema
// Multi-user with self-hosted option support

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum SubscriptionTier {
  free
  premium
  ad_supported
  self_hosted
}

enum AnalyticsEventType {
  item_created
  item_edited
  item_deleted
  item_worn
  outfit_created
  outfit_rated
  ai_catalog_generated
  ai_outfit_generated
  panic_pick_used
  search_performed
  filter_applied
  export_data
  page_view
  session_start
  session_end
}

enum PrivacySetting {
  all_data
  anonymized_only
  opt_out
}

enum Category {
  tops
  bottoms
  dresses
  outerwear
  shoes
  accessories
  underwear_bras
  jewelry
  swimwear
  activewear
  sleepwear
  loungewear
  suits_sets
}

enum AccessoryType {
  purse
  bag
  backpack
  belt
  hat
  scarf
  gloves
  sunglasses
  watch
  other
}

enum JewelryType {
  necklace
  earrings
  bracelet
  ring
  anklet
  brooch
  other
}

enum ShoeType {
  sneakers
  boots
  sandals
  heels
  flats
  loafers
  oxfords
  platforms
  other
}

enum BottomsType {
  jeans
  dress_pants
  casual_pants
  cargo_pants
  shorts
  skirt
  leggings
  joggers
  other
}

enum FranchiseType {
  band
  movie
  tv_show
  game
  anime
  comic
  sports
  brand
  other
}

enum ItemState {
  available
  laundry
  unavailable
  donate
}

enum CleanStatus {
  clean
  dirty
  needs_wash
}

enum StorageType {
  hanging
  folded
  drawer
  shelf
  box
  other
}

enum ImageKind {
  original_main
  original_back
  label_brand
  label_care
  detail
  ai_catalog
  thumbnail
  outfit_board
  outfit_person_wearing
}

enum OutfitRole {
  top
  bottom
  dress
  outerwear
  shoes
  accessory
  underwear_bras
  jewelry
  swimwear
  activewear
  sleepwear
  loungewear
  suit_set
}

enum OutfitRating {
  up
  down
  neutral
}

enum AIJobType {
  generate_catalog_image
  infer_item
  extract_label
  generate_outfit
  generate_outfit_visualization
}

enum AIJobStatus {
  queued
  running
  succeeded
  failed
  needs_review
}

// ============================================================================
// MODELS
// ============================================================================

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id                String           @id @default(uuid())
  email             String           @unique
  emailVerified     DateTime?        @map("email_verified")
  username          String?          @unique
  name              String?
  image             String?          // Profile image URL
  
  // Subscription & billing
  subscriptionTier  SubscriptionTier @default(free) @map("subscription_tier")
  stripeCustomerId  String?          @unique @map("stripe_customer_id")
  stripeSubscriptionId String?       @unique @map("stripe_subscription_id")
  subscriptionExpiry DateTime?       @map("subscription_expiry")
  
  // Privacy settings
  analyticsOptIn    Boolean          @default(false) @map("analytics_opt_in")
  dataSharing       PrivacySetting   @default(opt_out) @map("data_sharing")
  adConsent         Boolean          @default(false) @map("ad_consent")
  
  // Deployment type tracking
  isHostedUser      Boolean          @default(true) @map("is_hosted_user")   // false for self-hosted instances
  
  // Relationships
  items             Item[]
  outfits           Outfit[]
  analyticsEvents   AnalyticsEvent[]
  accounts          Account[]
  sessions          Session[]
  
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  lastLoginAt       DateTime?        @map("last_login_at")

  @@map("users")
}

// NextAuth.js models
model Account {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  type              String
  provider          String
  providerAccountId String   @map("provider_account_id")
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// ANALYTICS & DATA COLLECTION
// ============================================================================

model AnalyticsEvent {
  id                String              @id @default(uuid())
  userId            String?             @map("user_id")  // Null for anonymous/aggregated events
  user              User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  eventType         AnalyticsEventType  @map("event_type")
  eventData         Json?               @map("event_data")  // Flexible payload
  
  // Session tracking
  sessionId         String?             @map("session_id")
  
  // Context
  userAgent         String?             @map("user_agent")
  ipAddressHash     String?             @map("ip_address_hash")  // Hashed for privacy
  
  // Anonymization flag
  isAnonymized      Boolean             @default(false) @map("is_anonymized")
  
  createdAt         DateTime            @default(now()) @map("created_at")

  @@index([userId])
  @@index([eventType])
  @@index([sessionId])
  @@index([createdAt])
  @@map("analytics_events")
}

// ============================================================================
// WARDROBE ITEMS
// ============================================================================

model Item {
  id            String     @id @default(uuid())
  userId        String?    @map("user_id")  // Owner of the item (null for backwards compatibility)
  user          User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title         String?
  category      Category?
  state         ItemState  @default(available)
  
  // Sub-type categorization for accessories, jewelry, shoes, and bottoms
  accessoryType AccessoryType? @map("accessory_type")
  jewelryType   JewelryType?   @map("jewelry_type")
  shoeType      ShoeType?      @map("shoe_type")
  bottomsType   BottomsType?   @map("bottoms_type")
  
  // Label/brand info (may come from AI OCR)
  brand         String?
  sizeText      String?    @map("size_text")
  materials     String?    // JSON string or plain text
  
  // Licensed merchandise / band merch tracking
  isLicensedMerch Boolean?      @map("is_licensed_merch")  // Is this official licensed merchandise?
  franchise       String?                                   // Band name, movie title, game name, etc.
  franchiseType   FranchiseType? @map("franchise_type")    // Type of franchise (band, movie, tv_show, etc.)
  
  // AI-generated vs real item tracking
  isGenerated     Boolean        @default(false) @map("is_generated")  // Is this an AI-generated variation (not a real item)?
  sourceItemId    String?        @map("source_item_id")                 // If generated, ID of the original real item
  generationType  String?        @map("generation_type")                // Type: 'color_variation', 'seasonal', 'style_transfer', 'matching', etc.
  
  // AI-inferred attributes
  colorPalette  Json?      @map("color_palette") // ["#FF0000", "#000000"]
  attributes    Json?      // { "neckline": "crew", "sleeve_length": "short", ... }
  
  // Clean/wear tracking
  cleanStatus      CleanStatus @map("clean_status") @default(clean)
  wearsBeforeWash  Int         @map("wears_before_wash") @default(1) // How many wears before washing
  currentWears     Int         @map("current_wears") @default(0)     // Current wear count
  lastWornDate     DateTime?   @map("last_worn_date")                // When item was last worn
  lastWashedDate   DateTime?   @map("last_washed_date")              // When item was last washed
  
  // Physical location in closet
  storageType      StorageType? @map("storage_type")                  // How item is stored (hanging, folded, etc.)
  locationInCloset String?      @map("location_in_closet")            // Description: "Left side", "Top drawer", etc.
  sortOrder        Int?         @map("sort_order")                    // Optional order for organizing items
  
  // Relationships
  images        ImageAsset[]
  tags          ItemTag[]
  outfitItems   OutfitItem[]
  aiJobs        AIJob[]
  nfcTag        NFCTag?
  nfcEvents     NFCEvent[]
  
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  @@index([userId])
  @@map("items")
}

model ImageAsset {
  id          String     @id @default(uuid())
  itemId      String     @map("item_id")
  item        Item       @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  kind        ImageKind
  filePath    String     @map("file_path") // relative to DATA_DIR
  width       Int?
  height      Int?
  mimeType    String?    @map("mime_type")
  
  createdAt   DateTime   @default(now()) @map("created_at")

  @@index([itemId])
  @@index([kind])
  @@map("image_assets")
}

model Tag {
  id          String     @id @default(uuid())
  name        String     @unique
  itemTags    ItemTag[]
  createdAt   DateTime   @default(now()) @map("created_at")

  @@map("tags")
}

model ItemTag {
  itemId      String     @map("item_id")
  tagId       String     @map("tag_id")
  item        Item       @relation(fields: [itemId], references: [id], onDelete: Cascade)
  tag         Tag        @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([itemId, tagId])
  @@index([itemId])
  @@index([tagId])
  @@map("item_tags")
}

model Outfit {
  id               String       @id @default(uuid())
  userId           String?      @map("user_id")  // Owner of the outfit (null for backwards compatibility)
  user             User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title            String?
  notes            String?
  rating           OutfitRating @default(neutral)
  
  // Generation constraints
  weather          String?      // hot, warm, cool, cold, rain, snow
  vibe             String?      // dysphoria_safe, confidence_boost, dopamine, neutral
  occasion         String?
  timeAvailable    String?      @map("time_available") // quick, normal
  
  // AI-generated fields
  explanation      String?      @db.Text
  swapSuggestions  String?      @map("swap_suggestions") @db.Text
  
  items            OutfitItem[]
  images           OutfitImage[]
  aiJobs           AIJob[]
  
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  @@index([userId])
  @@map("outfits")
}

model OutfitItem {
  outfitId    String      @map("outfit_id")
  itemId      String      @map("item_id")
  role        OutfitRole
  
  outfit      Outfit      @relation(fields: [outfitId], references: [id], onDelete: Cascade)
  item        Item        @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@id([outfitId, itemId])
  @@index([outfitId])
  @@index([itemId])
  @@map("outfit_items")
}

model OutfitImage {
  id          String     @id @default(uuid())
  outfitId    String     @map("outfit_id")
  outfit      Outfit     @relation(fields: [outfitId], references: [id], onDelete: Cascade)
  
  kind        ImageKind  // outfit_board or outfit_person_wearing
  filePath    String     @map("file_path") // relative to DATA_DIR
  width       Int?
  height      Int?
  mimeType    String?    @map("mime_type")
  
  createdAt   DateTime   @default(now()) @map("created_at")

  @@index([outfitId])
  @@index([kind])
  @@map("outfit_images")
}

model AIJob {
  id              String       @id @default(uuid())
  type            AIJobType
  status          AIJobStatus  @default(queued)
  
  // References
  itemId          String?      @map("item_id")
  item            Item?        @relation(fields: [itemId], references: [id], onDelete: Cascade)
  outfitId        String?      @map("outfit_id")
  outfit          Outfit?      @relation(fields: [outfitId], references: [id], onDelete: Cascade)
  
  // Job data
  inputRefs       Json?        @map("input_refs")      // Input parameters/references
  outputJson      Json?        @map("output_json")     // Parsed AI response
  confidenceJson  Json?        @map("confidence_json") // Confidence scores
  modelName       String?      @map("model_name")      // e.g., "gpt-4-vision-preview"
  rawResponse     String?      @map("raw_response")    // Full API response for debugging
  error           String?
  
  // Job metadata
  attempts        Int          @default(0)
  maxAttempts     Int          @default(3) @map("max_attempts")
  
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  completedAt     DateTime?    @map("completed_at")

  @@index([itemId])
  @@index([outfitId])
  @@index([status])
  @@index([type])
  @@map("ai_jobs")
}

// ============================================================================
// NFC TAG MANAGEMENT
// ============================================================================

model NFCTag {
  id            String     @id @default(uuid())
  tagId         String     @unique @map("tag_id")  // NFC tag UID (unique identifier)
  label         String?                             // Optional user label: "Blue hanger", "Closet 1", etc.
  
  // Item association
  itemId        String     @unique @map("item_id")
  item          Item       @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  @@index([tagId])
  @@map("nfc_tags")
}

model NFCEvent {
  id            String     @id @default(uuid())
  tagId         String     @map("tag_id")         // NFC tag UID that was scanned
  itemId        String     @map("item_id")
  item          Item       @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  action        String                             // "removed" or "returned"
  notes         String?                            // Optional user notes
  
  createdAt     DateTime   @default(now()) @map("created_at")

  @@index([itemId])
  @@index([tagId])
  @@index([createdAt])
  @@map("nfc_events")
}
